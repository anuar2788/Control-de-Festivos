<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Festivos — v2</title>
  <style>
    :root{
      --bg:#0f172a;--card:#0b1220;--text:#e5e7eb;--muted:#94a3b8;--brand:#7c3aed;--ok:#10b981;--warn:#f59e0b;--danger:#ef4444;--border:#1f2937
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,system-ui,sans-serif;color:var(--text);background:linear-gradient(120deg,#0b1220, #0f172a)}
    .container{max-width:1100px;margin:28px auto;padding:0 14px}
    header{display:flex;gap:10px;align-items:center;margin-bottom:14px}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),#22d3ee);display:grid;place-items:center;font-weight:800}
    .title{font-weight:800;font-size:20px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:10px}
    .kpi{grid-template-columns:repeat(4,minmax(0,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .card h3{margin:0 0 6px 0;font-size:12px;font-weight:600;color:var(--muted)}
    .big{font-size:26px;font-weight:800}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1 1 260px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0a0f1a;color:var(--text)}
    button{cursor:pointer;border-color:var(--brand);background:linear-gradient(180deg, color-mix(in srgb,var(--brand) 55%, transparent), transparent)}
    .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center}
    .btn.warn{border-color:var(--warn)}.btn.success{border-color:var(--ok)}.btn.danger{border-color:var(--danger)}
    table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    thead{background:#0a0f1a}
    tbody tr:hover{background:#0d1422}
    .badge{padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .badge.ok{background:color-mix(in srgb,var(--ok) 20%, transparent)}
    .badge.pend{background:color-mix(in srgb,var(--warn) 20%, transparent)}
    .overdue{outline:1px solid var(--danger);box-shadow:inset 0 0 0 9999px color-mix(in srgb,var(--danger) 12%, transparent)}
    .toolbar{display:flex;gap:8px;align-items:end}
    .toolbar .grow{flex:1 1 auto}
    .right{text-align:right}
    .hidden{display:none!important}
    .toast{position:fixed;right:14px;bottom:14px;background:#0a0f1a;border:1px solid var(--border);padding:10px 12px;border-radius:12px}
    .loading{position:fixed;inset:0;background:rgba(2,6,23,.55);backdrop-filter:blur(2px);display:none;place-items:center;z-index:20}
    .spinner{width:36px;height:36px;border:3px solid #223049;border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:900px){.kpi{grid-template-columns:repeat(2,minmax(0,1fr))}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">F</div>
      <div>
        <div class="title">Control de Festivos</div>
        <div class="muted">Añade festivos trabajados, planifica devoluciones y marca cuándo se devuelven.</div>
      </div>
    </header>

    <div class="grid kpi">
      <div class="card"><h3>Pendientes</h3><div class="big" id="kpi-pend">—</div></div>
      <div class="card"><h3>Devueltos</h3><div class="big" id="kpi-dev">—</div></div>
      <div class="card"><h3>Próx. 7 días</h3><div class="big" id="kpi-next">—</div></div>
      <div class="card"><h3>Total registros</h3><div class="big" id="kpi-tot">—</div></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="card">
        <h3>Nuevo trabajador</h3>
        <div class="row">
          <div>
            <label>Nombre</label>
            <input id="w-nombre" placeholder="Nombre" />
          </div>
          <div>
            <label>Apellidos</label>
            <input id="w-apellidos" placeholder="Apellidos" />
          </div>
          <div style="align-self:end"><button class="btn" id="btn-add-worker">Añadir trabajador</button></div>
        </div>
      </div>

      <div class="card">
        <h3>Nuevo festivo trabajado</h3>
        <div class="row">
          <div>
            <label>Trabajador</label>
            <select id="f-trabajador"></select>
          </div>
          <div>
            <label>Fecha trabajada</label>
            <input type="date" id="f-fecha" />
          </div>
          <div>
            <label>Fecha devolución (plan)</label>
            <input type="date" id="f-dev-plan" />
          </div>
          <div>
            <label>¿Ya devuelto?</label>
            <select id="f-devuelto"><option value="no" selected>No</option><option value="si">Sí</option></select>
          </div>
          <div id="box-dev-real" class="hidden">
            <label>Fecha devuelto</label>
            <input type="date" id="f-dev-real" />
          </div>
          <div style="align-self:end"><button class="btn" id="btn-add-festivo">Añadir festivo</button></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Filtros</h3>
      <div class="toolbar">
        <div class="grow"><label>Búsqueda</label><input id="q" placeholder="Nombre o apellidos"/></div>
        <div><label>Estado</label><select id="f-estado"><option value="">Todos</option><option value="pendiente">Pendiente</option><option value="devuelto">Devuelto</option></select></div>
        <div><label>Desde</label><input type="date" id="f-desde"/></div>
        <div><label>Hasta</label><input type="date" id="f-hasta"/></div>
        <div><button class="btn" id="btn-aplicar">Aplicar</button></div>
        <div><button class="btn" id="btn-reset">Reset</button></div>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="row" style="align-items:center;margin-bottom:6px">
        <div class="muted">Registros: <span id="count">—</span></div>
        <div class="right" style="flex:1"><button class="btn" id="btn-export">Exportar CSV</button></div>
      </div>
      <table>
        <thead><tr><th>Trabajador</th><th>Fecha trabajada</th><th>Devolución (plan)</th><th>Estado</th><th>Fecha devuelto</th><th class="right">Acciones</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="loading" id="loading"><div class="spinner"></div></div>
  <div class="toast hidden" id="toast"></div>

  <script>
    const $ = s => document.querySelector(s);
    let WORKERS = [], ROWS = [];

    // Utilidades seguras con fechas vacías
    const fmt = (d) => { const dt = d instanceof Date ? d : (d ? new Date(d) : null); return (dt && !isNaN(dt)) ? dt.toISOString().slice(0,10) : ''; };
    const toast = (m) => { const t = $('#toast'); t.textContent = m; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2200); };
    const loading = (on) => $('#loading').style.display = on? 'grid' : 'none';

    function renderWorkers(){
      const sel = $('#f-trabajador');
      sel.innerHTML = '<option value="" disabled selected>Elige trabajador…</option>' + WORKERS.map(w=>`<option value="${w.id}">${w.nombre} ${w.apellidos}</option>`).join('');
    }
    function renderStats(s){ $('#kpi-pend').textContent=s.pendientes||0; $('#kpi-dev').textContent=s.devueltos||0; $('#kpi-next').textContent=s.proximos7d||0; $('#kpi-tot').textContent=s.total||0; }

    function renderTable(list){
      const t = $('#tbody');
      const today = new Date(); today.setHours(0,0,0,0);
      try {
        t.innerHTML = list.map(r=>{
          const fTrab = fmt(r.fechaTrabajada), fPlan = fmt(r.fechaProgDevolucion), fReal = fmt(r.fechaDevuelto);
          const fpd = r.fechaProgDevolucion ? new Date(r.fechaProgDevolucion) : null; if (fpd) fpd.setHours(0,0,0,0);
          const overdue = !r.devuelto && fpd && fpd < today;
          const estado = r.devuelto ? '<span class="badge ok">Devuelto</span>' : '<span class="badge pend">Pendiente</span>';
          return `<tr${overdue? ' class="overdue"':''}><td>${r.nombre||''}</td><td>${fTrab}</td><td>${fPlan}</td><td>${estado}</td><td>${fReal}</td><td class="right"><button class="btn warn" ${r.devuelto?'disabled':''} onclick="editPlan('${r.id}','${fPlan}')">Editar plan</button> <button class="btn success" ${r.devuelto?'disabled':''} onclick="markDevuelto('${r.id}')">Marcar devuelto</button> <button class="btn danger" onclick="delFestivo('${r.id}')">Borrar</button></td></tr>`;
        }).join('');
        document.getElementById('count').textContent = list.length;
      } catch(e){ console.error(e); toast('Error pintando tabla'); }
    }

    // Server calls
    function loadAll(){
      loading(true);
      google.script.run
        .withFailureHandler(err=>{ console.error(err); loading(false); toast('Error cargando: '+(err?.message||err)); })
        .withSuccessHandler(({workers, festivos, stats})=>{
          WORKERS = workers||[];
          ROWS = (festivos||[]).slice().sort((a,b)=> new Date(b.fechaTrabajada||0) - new Date(a.fechaTrabajada||0));
          renderWorkers(); renderTable(ROWS); renderStats(stats||{});
          loading(false);
        })
        .getInitialData();
    }

    function addWorker(){
      const nombre=$('#w-nombre').value.trim(), apellidos=$('#w-apellidos').value.trim();
      if(!nombre||!apellidos) return toast('Completa nombre y apellidos');
      const dup = WORKERS.some(w => (w.nombre+' '+w.apellidos).toLowerCase() === (nombre+' '+apellidos).toLowerCase());
      if(dup) return toast('Ese trabajador ya existe');
      loading(true);
      google.script.run
        .withFailureHandler(err=>{ console.error(err); loading(false); toast('Error trabajador: '+(err?.message||err)); })
        .withSuccessHandler(()=>{ $('#w-nombre').value=''; $('#w-apellidos').value=''; toast('Trabajador añadido'); loadAll(); })
        .addWorker({nombre,apellidos});
    }

    function addFestivo(){
      const trabajadorId=$('#f-trabajador').value, fechaTrabajada=$('#f-fecha').value, devuelto=$('#f-devuelto').value==='si', fechaProgDevolucion=$('#f-dev-plan').value||null, fechaDevuelto=$('#f-dev-real').value||null;
      if(!trabajadorId||!fechaTrabajada) return toast('Elige trabajador y fecha');
      if(devuelto&&!fechaDevuelto) return toast('Indica fecha devuelto');
      loading(true);
      google.script.run
        .withFailureHandler(err=>{ console.error(err); loading(false); toast('Error festivo: '+(err?.message||err)); })
        .withSuccessHandler(()=>{ $('#form-festivo')?.reset(); document.getElementById('box-dev-real').classList.add('hidden'); toast('Festivo guardado'); loadAll(); })
        .addFestivo({trabajadorId,fechaTrabajada,devuelto,fechaProgDevolucion,fechaDevuelto});
    }

    function editPlan(id, current){
      const fecha = prompt('Nueva fecha plan (YYYY-MM-DD)', current||''); if(!fecha) return;
      loading(true);
      google.script.run
        .withFailureHandler(err=>{ console.error(err); loading(false); toast('Error plan: '+(err?.message||err)); })
        .withSuccessHandler(()=>{ toast('Plan actualizado'); loadAll(); })
        .setPlanDevolucion(id, fecha);
    }
    function markDevuelto(id){ const fecha = prompt('Fecha devuelto (YYYY-MM-DD)', fmt(new Date())); if(!fecha) return; loading(true); google.script.run.withFailureHandler(err=>{ console.error(err); loading(false); toast('Error marcar: '+(err?.message||err)); }).withSuccessHandler(()=>{ toast('Marcado como devuelto'); loadAll(); }).setDevuelto(id, fecha); }
    function delFestivo(id){ if(!confirm('¿Borrar este registro?')) return; loading(true); google.script.run.withFailureHandler(err=>{ console.error(err); loading(false); toast('Error borrar: '+(err?.message||err)); }).withSuccessHandler(()=>{ toast('Borrado'); loadAll(); }).deleteFestivo(id); }

    function applyFilters(){
      const estado=$('#f-estado').value, q=$('#q').value.trim().toLowerCase(), desde=$('#f-desde').value, hasta=$('#f-hasta').value;
      loading(true);
      google.script.run
        .withFailureHandler(err=>{ console.error(err); loading(false); toast('Error filtros: '+(err?.message||err)); })
        .withSuccessHandler(list=>{ let filtered=list||[]; if(q){ filtered=filtered.filter(r=>(`${r.nombre}`.toLowerCase()).includes(q)); } ROWS=filtered; renderTable(filtered); loading(false); })
        .getFestivos({estado,desde,hasta});
    }
    function resetFilters(){ $('#q').value=''; $('#f-estado').value=''; $('#f-desde').value=''; $('#f-hasta').value=''; loadAll(); }

    function exportCSV(){ if(!ROWS.length) return toast('Nada que exportar'); const cols=['Trabajador','FechaTrabajada','FechaDevolucionPlan','Estado','FechaDevuelto']; const lines=[cols.join(',')].concat(ROWS.map(r=>['"'+(r.nombre||'')+'"', fmt(r.fechaTrabajada), fmt(r.fechaProgDevolucion), r.devuelto?'Devuelto':'Pendiente', fmt(r.fechaDevuelto)].join(','))); const blob=new Blob([lines.join('
')],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='festivos.csv'; a.click(); URL.revokeObjectURL(url); }

    document.addEventListener('DOMContentLoaded',()=>{
      loadAll();
      document.getElementById('btn-add-worker').addEventListener('click', addWorker);
      document.getElementById('btn-add-festivo').addEventListener('click', addFestivo);
      document.getElementById('btn-aplicar').addEventListener('click', applyFilters);
      document.getElementById('btn-reset').addEventListener('click', resetFilters);
      document.getElementById('btn-export').addEventListener('click', exportCSV);
      document.getElementById('f-devuelto').addEventListener('change', e=>{ if(e.target.value==='si') document.getElementById('box-dev-real').classList.remove('hidden'); else { document.getElementById('box-dev-real').classList.add('hidden'); document.getElementById('f-dev-real').value=''; } });
    });
  </script>
</body>
</html>
