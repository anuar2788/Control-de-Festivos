<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de DÃ­as Festivos - Supervisor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .supervisor-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }
        
        .supervisor-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s ease;
        }
        
        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 2rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-full {
            width: 100%;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 3.5rem;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 10px;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 1.1rem;
            color: #7f8c8d;
            font-weight: 600;
        }
        
        .dashboard-tabs {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tabs-header {
            display: flex;
            border-bottom: 1px solid #e9ecef;
        }
        
        .tab-btn {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-bottom-color: #2c3e50;
        }
        
        .tab-btn:not(.active):hover {
            background: #f8f9fa;
        }
        
        .tab-content {
            padding: 30px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .table th {
            background: #f8f9fa;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
        }
        
        .table td {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        .table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-returned {
            background: #d4edda;
            color: #155724;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }
        
        .close:hover {
            color: #000;
        }
        
        .alert {
            padding: 16px;
            border-radius: 12px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .hidden {
            display: none !important;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .supervisor-info {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs-header {
                flex-direction: column;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-form">
                <h2>ð Acceso Supervisor</h2>
                <div id="loginAlert"></div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="usuario">Usuario:</label>
                        <input type="text" id="usuario" name="usuario" required placeholder="Ingresa tu usuario">
                    </div>
                    <div class="form-group">
                        <label for="password">ContraseÃ±a:</label>
                        <input type="password" id="password" name="password" required placeholder="Ingresa tu contraseÃ±a">
                    </div>
                    <button type="submit" class="btn btn-full">Iniciar SesiÃ³n</button>
                </form>
                <div class="alert" style="background: #cce7ff; color: #0c5460; border: 1px solid #b8daff; margin-top: 20px; font-size: 14px;">
                    <strong>ð Datos de acceso por defecto:</strong><br>
                    <strong>Usuario:</strong> admin<br>
                    <strong>ContraseÃ±a:</strong> admin123
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <div class="container">
            <div class="header">
                <h1>ð¯ Control de DÃ­as Festivos</h1>
                <div class="supervisor-info">
                    <div class="supervisor-badge">
                        <span>ð¨âð¼</span>
                        <span id="supervisorName">Supervisor</span>
                    </div>
                    <button class="logout-btn" onclick="logout()">Cerrar SesiÃ³n</button>
                </div>
            </div>

            <!-- EstadÃ­sticas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRegistros">0</div>
                    <div class="stat-label">Total Registros</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalHoras">0</div>
                    <div class="stat-label">Horas Trabajadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="horasPendientes">0</div>
                    <div class="stat-label">Horas Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="horasDevueltas">0</div>
                    <div class="stat-label">Horas Devueltas</div>
                </div>
            </div>

            <!-- Tabs Dashboard -->
            <div class="dashboard-tabs">
                <div class="tabs-header">
                    <button class="tab-btn active" onclick="switchTab('trabajadores')">ð¥ Trabajadores</button>
                    <button class="tab-btn" onclick="switchTab('festivos')">ð Festivos</button>
                    <button class="tab-btn" onclick="switchTab('stats')">ð EstadÃ­sticas</button>
                </div>

                <!-- Tab Trabajadores -->
                <div id="tab-trabajadores" class="tab-content active">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>ð¥ GestiÃ³n de Trabajadores</h3>
                        <button class="btn btn-success" onclick="openTrabajadorModal()">â Nuevo Trabajador</button>
                    </div>
                    
                    <div id="trabajadoresLoading" class="loading hidden">
                        <div class="spinner"></div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>CÃ©dula</th>
                                    <th>Departamento</th>
                                    <th>F. Ingreso</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="trabajadoresTable">
                                <tr>
                                    <td colspan="6" class="empty-state">
                                        <div style="font-size: 3rem; margin-bottom: 10px;">ð¥</div>
                                        <div>No hay trabajadores registrados</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Festivos -->
                <div id="tab-festivos" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>ð Registro de Festivos</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="loadFestivos()">ð Actualizar</button>
                            <button class="btn btn-success" onclick="openFestivoModal()">â Nuevo Festivo</button>
                        </div>
                    </div>
                    
                    <div id="festivosLoading" class="loading hidden">
                        <div class="spinner"></div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Trabajador</th>
                                    <th>Fecha Festivo</th>
                                    <th>Nombre Festivo</th>
                                    <th>Horas</th>
                                    <th>F. DevoluciÃ³n</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="festivosTable">
                                <tr>
                                    <td colspan="7" class="empty-state">
                                        <div style="font-size: 3rem; margin-bottom: 10px;">ð</div>
                                        <div>No hay festivos registrados</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab EstadÃ­sticas -->
                <div id="tab-stats" class="tab-content">
                    <h3>ð EstadÃ­sticas y Reportes</h3>
                    
                    <div class="chart-container">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Trabajador -->
    <div id="trabajadorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="trabajadorModalTitle">Nuevo Trabajador</h3>
                <button type="button" class="close" onclick="closeTrabajadorModal()">&times;</button>
            </div>
            <div id="trabajadorAlert"></div>
            <form id="trabajadorForm">
                <input type="hidden" id="trabajadorId" name="id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="trabajadorNombre">Nombre *</label>
                        <input type="text" id="trabajadorNombre" name="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="trabajadorApellidos">Apellidos *</label>
                        <input type="text" id="trabajadorApellidos" name="apellidos" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="trabajadorCedula">CÃ©dula *</label>
                        <input type="text" id="trabajadorCedula" name="cedula" required>
                    </div>
                    <div class="form-group">
                        <label for="trabajadorDepartamento">Departamento</label>
                        <input type="text" id="trabajadorDepartamento" name="departamento">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="trabajadorFechaIngreso">Fecha de Ingreso</label>
                        <input type="date" id="trabajadorFechaIngreso" name="fecha_ingreso">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="trabajadorActivo" name="activo" checked>
                            Trabajador activo
                        </label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success" style="flex: 1;">Guardar</button>
                    <button type="button" class="btn" onclick="closeTrabajadorModal()" style="flex: 1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Festivo -->
    <div id="festivoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="festivoModalTitle">Nuevo Festivo</h3>
                <button type="button" class="close" onclick="closeFestivoModal()">&times;</button>
            </div>
            <div id="festivoAlert"></div>
            <form id="festivoForm">
                <input type="hidden" id="festivoId" name="id">
                <div class="form-group">
                    <label for="festivoTrabajador">Trabajador *</label>
                    <select id="festivoTrabajador" name="trabajador_id" required>
                        <option value="">Selecciona un trabajador...</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="festivoFecha">Fecha del Festivo *</label>
                        <input type="date" id="festivoFecha" name="fecha_festivo" required>
                    </div>
                    <div class="form-group">
                        <label for="festivoNombre">Nombre del Festivo</label>
                        <input type="text" id="festivoNombre" name="nombre_festivo" placeholder="ej. Navidad">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="festivoHoras">Horas Trabajadas *</label>
                        <input type="number" id="festivoHoras" name="horas_trabajadas" min="1" max="24" required>
                    </div>
                    <div class="form-group">
                        <label for="festivoDevolucion">Fecha de DevoluciÃ³n</label>
                        <input type="date" id="festivoDevolucion" name="fecha_devolucion">
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="festivoDevuelto" name="devuelto">
                        Marcado como devuelto
                    </label>
                </div>
                <div class="form-group">
                    <label for="festivoNotas">Notas</label>
                    <textarea id="festivoNotas" name="notas" rows="3" placeholder="Observaciones adicionales..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success" style="flex: 1;">Guardar</button>
                    <button type="button" class="btn" onclick="closeFestivoModal()" style="flex: 1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============ CONFIGURACIÃN ============
        const API_URL = 'https://script.google.com/macros/s/AKfycbxrvpO3fDydsFYZeN7FT4Vyln7l5nZ4zx6xeDQ68gsUjL8TKAhy_qIVTYdPOAtnJDBxTw/exec'; // ð´ CAMBIAR POR TU URL REAL
        
        // ============ VARIABLES GLOBALES ============
        let currentSupervisor = null;
        let currentToken = null;
        let trabajadores = [];
        let festivos = [];
        let stats = {};
        let currentChart = null;

        // ============ INICIALIZACIÃN ============
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('trabajadorForm').addEventListener('submit', handleTrabajadorSubmit);
            document.getElementById('festivoForm').addEventListener('submit', handleFestivoSubmit);
            
            checkSavedSession();
        });

        // ============ AUTENTICACIÃN ============
        async function handleLogin(e) {
            e.preventDefault();
            
            const usuario = document.getElementById('usuario').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!usuario || !password) {
                showAlert('loginAlert', 'Por favor completa todos los campos', 'error');
                return;
            }
            
            showAlert('loginAlert', '', '');
            
            try {
                const response = await apiCall('login', {
                    usuario: usuario,
                    password: password
                });
                
                if (response.success) {
                    currentSupervisor = response.data.supervisor;
                    currentToken = response.data.token;
                    
                    sessionStorage.setItem('festivos_supervisor', JSON.stringify(currentSupervisor));
                    sessionStorage.setItem('festivos_token', currentToken);
                    
                    showDashboard();
                    await loadInitialData();
                } else {
                    showAlert('loginAlert', response.error.message || 'Error de autenticaciÃ³n', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAlert('loginAlert', 'Error de conexiÃ³n. Verifica la URL de la API.', 'error');
            }
        }

        function checkSavedSession() {
            const savedSupervisor = sessionStorage.getItem('festivos_supervisor');
            const savedToken = sessionStorage.getItem('festivos_token');
            
            if (savedSupervisor && savedToken) {
                currentSupervisor = JSON.parse(savedSupervisor);
                currentToken = savedToken;
                showDashboard();
                loadInitialData();
            }
        }

        function logout() {
            sessionStorage.clear();
            currentSupervisor = null;
            currentToken = null;
            
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            document.getElementById('loginForm').reset();
            showAlert('loginAlert', '', '');
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            document.getElementById('supervisorName').textContent = currentSupervisor.nombre || currentSupervisor.usuario;
        }

        // ============ LLAMADAS A LA API ============
        async function apiCall(action, data = {}) {
            const payload = {
                action: action,
                ...data
            };
            
            if (currentToken) {
                payload.token = currentToken;
            }
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        }

        // ============ CARGA DE DATOS ============
        async function loadInitialData() {
            await Promise.all([
                loadTrabajadores(),
                loadFestivos(),
                loadStats()
            ]);
        }

        async function loadTrabajadores() {
            showLoading('trabajadoresLoading', true);
            try {
                const response = await apiCall('trabajadores_list');
                if (response.success) {
                    trabajadores = response.data.trabajadores;
                    renderTrabajadores();
                    updateTrabajadorSelect();
                } else {
                    console.error('Error loading trabajadores:', response.error);
                }
            } catch (error) {
                console.error('Error loading trabajadores:', error);
            } finally {
                showLoading('trabajadoresLoading', false);
            }
        }

        async function loadFestivos() {
            showLoading('festivosLoading', true);
            try {
                const response = await apiCall('festivos_list');
                if (response.success) {
                    festivos = response.data.festivos;
                    renderFestivos();
                } else {
                    console.error('Error loading festivos:', response.error);
                }
            } catch (error) {
                console.error('Error loading festivos:', error);
            } finally {
                showLoading('festivosLoading', false);
            }
        }

        async function loadStats() {
            try {
                const response = await apiCall('stats');
                if (response.success) {
                    stats = response.data.stats;
                    renderStats();
                    renderChart();
                } else {
                    console.error('Error loading stats:', response.error);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // ============ RENDERIZADO DE DATOS ============
        function renderTrabajadores() {
            const tbody = document.getElementById('trabajadoresTable');
            
            if (trabajadores.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div style="font-size: 3rem; margin-bottom: 10px;">ð¥</div>
                            <div>No hay trabajadores registrados</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = trabajadores.map(trabajador => `
                <tr>
                    <td><strong>${trabajador.nombre_completo}</strong></td>
                    <td>${trabajador.cedula}</td>
                    <td>${trabajador.departamento || '-'}</td>
                    <td>${trabajador.fecha_ingreso || '-'}</td>
                    <td>
                        <span class="status-badge ${trabajador.activo ? 'status-active' : 'status-inactive'}">
                            ${trabajador.activo ? 'â Activo' : 'â Inactivo'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-small" onclick="editTrabajador('${trabajador.id}')">âï¸ Editar</button>
                        <button class="btn btn-danger btn-small" onclick="deleteTrabajador('${trabajador.id}', '${trabajador.nombre_completo}')" style="margin-left: 5px;">ðï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderFestivos() {
            const tbody = document.getElementById('festivosTable');
            
            if (festivos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div style="font-size: 3rem; margin-bottom: 10px;">ð</div>
                            <div>No hay festivos registrados</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = festivos.map(festivo => `
                <tr>
                    <td><strong>${festivo.trabajador_nombre}</strong></td>
                    <td>${festivo.fecha_festivo}</td>
                    <td>${festivo.nombre_festivo || '-'}</td>
                    <td><strong>${festivo.horas_trabajadas}h</strong></td>
                    <td>${festivo.fecha_devolucion || '-'}</td>
                    <td>
                        <span class="status-badge ${festivo.devuelto ? 'status-returned' : 'status-pending'}">
                            ${festivo.devuelto ? 'â Devuelto' : 'â³ Pendiente'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-small" onclick="editFestivo('${festivo.id}')">âï¸ Editar</button>
                        <button class="btn btn-danger btn-small" onclick="deleteFestivo('${festivo.id}')" style="margin-left: 5px;">ðï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderStats() {
            document.getElementById('totalRegistros').textContent = stats.total_registros || 0;
            document.getElementById('totalHoras').textContent = stats.total_horas || 0;
            document.getElementById('horasPendientes').textContent = stats.horas_pendientes || 0;
            document.getElementById('horasDevueltas').textContent = stats.horas_devueltas || 0;
        }

        function renderChart() {
            const ctx = document.getElementById('statsChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            // Agrupar festivos por mes
            const monthlyData = {};
            festivos.forEach(festivo => {
                if (festivo.fecha_festivo) {
                    const month = festivo.fecha_festivo.substring(0, 7);
                    if (!monthlyData[month]) {
                        monthlyData[month] = { total: 0, devuelto: 0 };
                    }
                    monthlyData[month].total += festivo.horas_trabajadas;
                    if (festivo.devuelto) {
                        monthlyData[month].devuelto += festivo.horas_trabajadas;
                    }
                }
            });
            
            const months = Object.keys(monthlyData).sort().slice(-6);
            const totalHours = months.map(m => monthlyData[m]?.total || 0);
            const returnedHours = months.map(m => monthlyData[m]?.devuelto || 0);
            const pendingHours = months.map((m, i) => totalHours[i] - returnedHours[i]);
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Horas Devueltas',
                            data: returnedHours,
                            backgroundColor: 'rgba(46, 204, 113, 0.8)',
                            borderColor: 'rgba(46, 204, 113, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Horas Pendientes',
                            data: pendingHours,
                            backgroundColor: 'rgba(241, 196, 15, 0.8)',
                            borderColor: 'rgba(241, 196, 15, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'EvoluciÃ³n de Horas por Mes',
                            font: { size: 18 }
                        },
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Mes' } },
                        y: { beginAtZero: true, title: { display: true, text: 'Horas' } }
                    }
                }
            });
        }

        function updateTrabajadorSelect() {
            const select = document.getElementById('festivoTrabajador');
            select.innerHTML = '<option value="">Selecciona un trabajador...</option>';
            
            trabajadores.filter(t => t.activo).forEach(trabajador => {
                const option = document.createElement('option');
                option.value = trabajador.id;
                option.textContent = trabajador.nombre_completo;
                select.appendChild(option);
            });
        }

        // ============ MANEJO DE TABS ============
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            if (tabName === 'stats' && (!stats.total_registros && festivos.length > 0)) {
                loadStats();
            }
        }

        // ============ MODALES TRABAJADOR ============
        function openTrabajadorModal(trabajador = null) {
            const modal = document.getElementById('trabajadorModal');
            const form = document.getElementById('trabajadorForm');
            const title = document.getElementById('trabajadorModalTitle');
            
            form.reset();
            showAlert('trabajadorAlert', '', '');
            
            if (trabajador) {
                title.textContent = 'Editar Trabajador';
                document.getElementById('trabajadorId').value = trabajador.id;
                document.getElementById('trabajadorNombre').value = trabajador.nombre;
                document.getElementById('trabajadorApellidos').value = trabajador.apellidos;
                document.getElementById('trabajadorCedula').value = trabajador.cedula;
                document.getElementById('trabajadorDepartamento').value = trabajador.departamento || '';
                document.getElementById('trabajadorFechaIngreso').value = trabajador.fecha_ingreso || '';
                document.getElementById('trabajadorActivo').checked = trabajador.activo;
            } else {
                title.textContent = 'Nuevo Trabajador';
                document.getElementById('trabajadorActivo').checked = true;
            }
            
            modal.style.display = 'block';
        }

        function closeTrabajadorModal() {
            document.getElementById('trabajadorModal').style.display = 'none';
        }

        function editTrabajador(id) {
            const trabajador = trabajadores.find(t => t.id === id);
            if (trabajador) {
                openTrabajadorModal(trabajador);
            }
        }

        async function deleteTrabajador(id, nombre) {
            if (!confirm(`Â¿EstÃ¡s seguro de eliminar al trabajador "${nombre}"?`)) return;
            
            try {
                const response = await apiCall('trabajador_delete', { id: id });
                if (response.success) {
                    await loadTrabajadores();
                    await loadStats();
                } else {
                    alert('Error al eliminar trabajador: ' + response.error.message);
                }
            } catch (error) {
                console.error('Error deleting trabajador:', error);
                alert('Error de conexiÃ³n al eliminar trabajador');
            }
        }

        async function handleTrabajadorSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                nombre: formData.get('nombre').trim(),
                apellidos: formData.get('apellidos').trim(),
                cedula: formData.get('cedula').trim(),
                departamento: formData.get('departamento').trim(),
                fecha_ingreso: formData.get('fecha_ingreso'),
                activo: formData.has('activo')
            };
            
            if (!data.nombre || !data.apellidos || !data.cedula) {
                showAlert('trabajadorAlert', 'Por favor completa todos los campos obligatorios', 'error');
                return;
            }
            
            try {
                const id = formData.get('id');
                const action = id ? 'trabajador_update' : 'trabajador_create';
                const payload = id ? { id: id, trabajador: data } : { trabajador: data };
                
                const response = await apiCall(action, payload);
                
                if (response.success) {
                    showAlert('trabajadorAlert', 'â Trabajador guardado exitosamente', 'success');
                    setTimeout(() => {
                        closeTrabajadorModal();
                        loadTrabajadores();
                        loadStats();
                    }, 1500);
                } else {
                    showAlert('trabajadorAlert', response.error.message || 'Error al guardar trabajador', 'error');
                }
            } catch (error) {
                console.error('Error saving trabajador:', error);
                showAlert('trabajadorAlert', 'Error de conexiÃ³n al guardar', 'error');
            }
        }

        // ============ MODALES FESTIVO ============
        function openFestivoModal(festivo = null) {
            const modal = document.getElementById('festivoModal');
            const form = document.getElementById('festivoForm');
            const title = document.getElementById('festivoModalTitle');
            
            form.reset();
            showAlert('festivoAlert', '', '');
            
            if (festivo) {
                title.textContent = 'Editar Festivo';
                document.getElementById('festivoId').value = festivo.id;
                document.getElementById('festivoTrabajador').value = festivo.trabajador_id;
                document.getElementById('festivoFecha').value = festivo.fecha_festivo;
                document.getElementById('festivoNombre').value = festivo.nombre_festivo || '';
                document.getElementById('festivoHoras').value = festivo.horas_trabajadas;
                document.getElementById('festivoDevolucion').value = festivo.fecha_devolucion || '';
                document.getElementById('festivoDevuelto').checked = festivo.devuelto;
                document.getElementById('festivoNotas').value = festivo.notas || '';
            } else {
                title.textContent = 'Nuevo Festivo';
            }
            
            modal.style.display = 'block';
        }

        function closeFestivoModal() {
            document.getElementById('festivoModal').style.display = 'none';
        }

        function editFestivo(id) {
            const festivo = festivos.find(f => f.id === id);
            if (festivo) {
                openFestivoModal(festivo);
            }
        }

        async function deleteFestivo(id) {
            if (!confirm('Â¿EstÃ¡s seguro de eliminar este registro de festivo?')) return;
            
            try {
                const response = await apiCall('festivo_delete', { id: id });
                if (response.success) {
                    await loadFestivos();
                    await loadStats();
                } else {
                    alert('Error al eliminar festivo: ' + response.error.message);
                }
            } catch (error) {
                console.error('Error deleting festivo:', error);
                alert('Error de conexiÃ³n al eliminar festivo');
            }
        }

        async function handleFestivoSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                trabajador_id: formData.get('trabajador_id'),
                fecha_festivo: formData.get('fecha_festivo'),
                nombre_festivo: formData.get('nombre_festivo').trim(),
                horas_trabajadas: parseInt(formData.get('horas_trabajadas')),
                fecha_devolucion: formData.get('fecha_devolucion'),
                devuelto: formData.has('devuelto'),
                notas: formData.get('notas').trim()
            };
            
            if (!data.trabajador_id || !data.fecha_festivo || !data.horas_trabajadas) {
                showAlert('festivoAlert', 'Por favor completa todos los campos obligatorios', 'error');
                return;
            }
            
            if (data.horas_trabajadas < 1 || data.horas_trabajadas > 24) {
                showAlert('festivoAlert', 'Las horas deben estar entre 1 y 24', 'error');
                return;
            }
            
            try {
                const id = formData.get('id');
                const action = id ? 'festivo_update' : 'festivo_create';
                const payload = id ? { id: id, festivo: data } : { festivo: data };
                
                const response = await apiCall(action, payload);
                
                if (response.success) {
                    showAlert('festivoAlert', 'â Festivo guardado exitosamente', 'success');
                    setTimeout(() => {
                        closeFestivoModal();
                        loadFestivos();
                        loadStats();
                    }, 1500);
                } else {
                    showAlert('festivoAlert', response.error.message || 'Error al guardar festivo', 'error');
                }
            } catch (error) {
                console.error('Error saving festivo:', error);
                showAlert('festivoAlert', 'Error de conexiÃ³n al guardar', 'error');
            }
        }

        // ============ UTILIDADES ============
        function showAlert(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (!message) {
                element.innerHTML = '';
                return;
            }
            
            const alertClass = type === 'error' ? 'alert-error' : 
                              type === 'success' ? 'alert-success' : 'alert';
            
            element.innerHTML = `<div class="${alertClass}">${message}</div>`;
        }

        function showLoading(elementId, show) {
            const element = document.getElementById(elementId);
            if (show) {
                element.classList.remove('hidden');
            } else {
                element.classList.add('hidden');
            }
        }

        // ============ EVENTOS DE VENTANA ============
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
