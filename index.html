<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Control de D√≠as Festivos - Supervisor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
    .container { max-width:1600px; margin:0 auto; padding:20px; }
    .header { background:rgba(255,255,255,.95); backdrop-filter:blur(10px); padding:25px; border-radius:20px; margin-bottom:30px; box-shadow:0 20px 40px rgba(0,0,0,.1); }
    .header h1 { color:#2c3e50; font-size:2.2rem; margin-bottom:10px; text-align:center; }
    .supervisor-info { display:flex; justify-content:space-between; align-items:center; margin-top:20px; padding-top:20px; border-top:2px solid #e9ecef; gap:12px; }
    .supervisor-badge { background:linear-gradient(45deg,#667eea,#764ba2); color:#fff; padding:12px 24px; border-radius:25px; font-weight:600; display:flex; align-items:center; gap:8px; }
    .toolbar { display:flex; gap:8px; align-items:center; }
    .logout-btn { background:#e74c3c; color:#fff; border:none; padding:10px 16px; border-radius:25px; cursor:pointer; font-weight:600; transition:.3s; }
    .logout-btn:hover { background:#c0392b; transform:translateY(-2px); }
    .gear, .test-btn { background:#f1f3f5; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; }

    .login-container { display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px; }
    .login-form { background:rgba(255,255,255,.95); backdrop-filter:blur(10px); padding:40px; border-radius:20px; max-width:420px; width:100%; box-shadow:0 20px 40px rgba(0,0,0,.2); animation:fadeIn .5s ease; }
    .login-form h2 { text-align:center; margin-bottom:10px; color:#2c3e50; font-size:1.8rem; }
    .subtle { font-size:12px; color:#6c757d; margin-bottom:10px; word-break:break-all }
    .form-group { margin-bottom:16px; }
    .form-group label { display:block; margin-bottom:8px; font-weight:600; color:#2c3e50; }
    .form-group input, .form-group select, .form-group textarea { width:100%; padding:12px; border:2px solid #e9ecef; border-radius:12px; font-size:16px; transition:.3s; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.1); transform:translateY(-1px); }

    .btn { background:linear-gradient(45deg,#667eea,#764ba2); color:#fff; border:none; padding:12px 20px; border-radius:12px; cursor:pointer; font-weight:600; font-size:16px; transition:.3s; display:inline-block; text-decoration:none; text-align:center; }
    .btn:hover { transform:translateY(-2px); box-shadow:0 10px 20px rgba(102,126,234,.3); }
    .btn-full { width:100%; }
    .btn-success { background:linear-gradient(45deg,#27ae60,#2ecc71); }
    .btn-danger { background:linear-gradient(45deg,#e74c3c,#c0392b); }
    .btn-small { padding:8px 12px; font-size:14px; }

    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:30px; }
    .stat-card { background:rgba(255,255,255,.95); backdrop-filter:blur(10px); padding:24px; border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,.1); text-align:center; transition:.3s; position:relative; overflow:hidden; }
    .stat-card::before { content:''; position:absolute; top:0; left:0; right:0; height:4px; background:linear-gradient(90deg,#667eea,#764ba2); }
    .stat-card:hover { transform:translateY(-5px); box-shadow:0 25px 50px rgba(0,0,0,.15); }
    .stat-number { font-size:2.4rem; font-weight:800; color:#667eea; margin-bottom:6px; line-height:1; }
    .stat-label { font-size:0.95rem; color:#7f8c8d; font-weight:600; }

    .dashboard-tabs { background:rgba(255,255,255,.95); backdrop-filter:blur(10px); border-radius:20px; margin-bottom:30px; box-shadow:0 20px 40px rgba(0,0,0,.1); overflow:hidden; }
    .tabs-header { display:flex; border-bottom:1px solid #e9ecef; }
    .tab-btn { flex:1; padding:16px; background:none; border:none; font-size:16px; font-weight:600; cursor:pointer; transition:.3s; border-bottom:3px solid transparent; }
    .tab-btn.active { background:linear-gradient(45deg,#667eea,#764ba2); color:#fff; border-bottom-color:#2c3e50; }
    .tab-btn:not(.active):hover { background:#f8f9fa; }
    .tab-content { padding:24px; display:none; }
    .tab-content.active { display:block; }

    .table-container { overflow-x:auto; border-radius:12px; border:1px solid #e9ecef; }
    .table { width:100%; border-collapse:collapse; background:#fff; }
    .table th { background:#f8f9fa; padding:12px; text-align:left; font-weight:600; color:#2c3e50; border-bottom:2px solid #e9ecef; }
    .table td { padding:12px; border-bottom:1px solid #e9ecef; vertical-align:middle; }
    .table tbody tr:hover { background:#f8f9fa; }

    .status-badge { padding:6px 12px; border-radius:20px; font-size:.85rem; font-weight:600; display:inline-flex; align-items:center; gap:6px; }
    .status-pending { background:#fff3cd; color:#856404; }
    .status-returned { background:#d4edda; color:#155724; }
    .status-active { background:#d4edda; color:#155724; }
    .status-inactive { background:#f8d7da; color:#721c24; }

    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,.5); backdrop-filter:blur(5px); }
    .modal-content { background:#fff; margin:5% auto; padding:24px; border-radius:20px; width:90%; max-width:520px; box-shadow:0 30px 60px rgba(0,0,0,.3); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:12px; border-bottom:2px solid #e9ecef; }
    .close { background:none; border:none; font-size:24px; cursor:pointer; color:#aaa; }
    .close:hover { color:#000; }

    .alert { padding:12px; border-radius:12px; margin:10px 0; font-weight:500; }
    .alert-error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
    .alert-success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }

    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .form-actions { display:flex; gap:12px; margin-top:16px; }

    .empty-state { text-align:center; padding:40px 16px; color:#7f8c8d; }
    .loading { display:flex; justify-content:center; align-items:center; padding:24px; }
    .spinner { width:36px; height:36px; border:4px solid #f3f3f3; border-top:4px solid #667eea; border-radius:50%; animation:spin 1s linear infinite; }
    .hidden { display:none !important; }
    .chart-container { position:relative; height:360px; margin-top:12px; }

    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#f1f3f5; border:1px solid #dee2e6; border-bottom-width:3px; padding:2px 6px; border-radius:6px; font-size:12px;}
    pre.debug { background:#0e122b; color:#dbe4ff; border-radius:12px; padding:12px; overflow:auto; max-height:240px; font-size:12px; }
    .pill { display:inline-flex; align-items:center; gap:6px; background:#f1f3f5; border:1px solid #dee2e6; border-radius:999px; padding:4px 10px; font-size:12px; }

    @keyframes fadeIn { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    @media (max-width:768px){
      .header h1{font-size:1.6rem}
      .supervisor-info{flex-direction:column; gap:12px; text-align:center}
      .stats-grid{grid-template-columns:1fr}
      .tabs-header{flex-direction:column}
      .form-row{grid-template-columns:1fr}
      .form-actions{flex-direction:column}
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen">
    <div class="login-container">
      <div class="login-form">
        <h2>üîê Acceso Supervisor</h2>
        <div class="subtle">Puedes pasar el endpoint por query <span class="kbd">?api=https://.../exec</span> o activar modo mock con <span class="kbd">?mock=1</span>. Debug: <span class="kbd">?debug=1</span></div>
        <div id="loginAlert"></div>
        <form id="loginForm">
          <div class="form-group">
            <label for="usuario">Usuario:</label>
            <input type="text" id="usuario" name="usuario" required placeholder="Ingresa tu usuario" />
          </div>
          <div class="form-group">
            <label for="password">Contrase√±a:</label>
            <input type="password" id="password" name="password" required placeholder="Ingresa tu contrase√±a" />
          </div>
          <button type="submit" class="btn btn-full">Iniciar Sesi√≥n</button>
        </form>
        <div id="loginTech" class="hidden">
          <div style="margin-top:10px; font-weight:600;">Detalles t√©cnicos</div>
          <pre class="debug" id="loginDebug"></pre>
        </div>
        <div class="alert" style="background:#cce7ff;color:#0c5460;border:1px solid #b8daff;margin-top:12px;font-size:14px;">
          <strong>üîë Datos por defecto (mock o si tu API los acepta):</strong><br />
          <strong>Usuario:</strong> admin<br />
          <strong>Contrase√±a:</strong> admin123
        </div>
        <div class="subtle" id="apiBadge"></div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <div class="container">
      <div class="header">
        <h1>üéØ Control de D√≠as Festivos</h1>
        <div class="supervisor-info">
          <div class="supervisor-badge">
            <span>üë®‚Äçüíº</span>
            <span id="supervisorName">Supervisor</span>
          </div>
          <div class="toolbar">
            <span class="pill" id="envInfo">API</span>
            <button class="gear" onclick="openConfig()">‚öôÔ∏è Configuraci√≥n</button>
            <button class="test-btn" id="btnTests" onclick="openTests()" title="Panel de pruebas">üß™ Pruebas</button>
            <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
          </div>
        </div>
      </div>

      <!-- Estad√≠sticas -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalRegistros">0</div>
          <div class="stat-label">Total Registros</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalHoras">0</div>
          <div class="stat-label">Horas Trabajadas</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="horasPendientes">0</div>
          <div class="stat-label">Horas Pendientes</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="horasDevueltas">0</div>
          <div class="stat-label">Horas Devueltas</div>
        </div>
      </div>

      <!-- Tabs Dashboard -->
      <div class="dashboard-tabs">
        <div class="tabs-header">
          <button class="tab-btn active" onclick="switchTab('trabajadores', this)">üë• Trabajadores</button>
          <button class="tab-btn" onclick="switchTab('festivos', this)">üìÖ Festivos</button>
          <button class="tab-btn" onclick="switchTab('stats', this)">üìä Estad√≠sticas</button>
        </div>

        <!-- Tab Trabajadores -->
        <div id="tab-trabajadores" class="tab-content active">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3>üë• Gesti√≥n de Trabajadores</h3>
            <div>
              <button class="btn btn-success" onclick="openTrabajadorModal()">‚ûï Nuevo Trabajador</button>
            </div>
          </div>
          <div id="trabajadoresLoading" class="loading hidden"><div class="spinner"></div></div>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>C√©dula</th>
                  <th>Departamento</th>
                  <th>F. Ingreso</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="trabajadoresTable">
                <tr>
                  <td colspan="6" class="empty-state">
                    <div style="font-size:2rem;margin-bottom:6px;">üë•</div>
                    <div>No hay trabajadores registrados</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tab Festivos -->
        <div id="tab-festivos" class="tab-content">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3>üìÖ Registro de Festivos</h3>
            <div style="display:flex;gap:10px;">
              <button class="btn" onclick="loadFestivos()">üîÑ Actualizar</button>
              <button class="btn btn-success" onclick="openFestivoModal()">‚ûï Nuevo Festivo</button>
            </div>
          </div>
          <div id="festivosLoading" class="loading hidden"><div class="spinner"></div></div>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Trabajador</th>
                  <th>Fecha Festivo</th>
                  <th>Nombre Festivo</th>
                  <th>Horas</th>
                  <th>F. Devoluci√≥n</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="festivosTable">
                <tr>
                  <td colspan="7" class="empty-state">
                    <div style="font-size:2rem;margin-bottom:6px;">üìÖ</div>
                    <div>No hay festivos registrados</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tab Estad√≠sticas -->
        <div id="tab-stats" class="tab-content">
          <h3>üìä Estad√≠sticas y Reportes</h3>
          <div class="chart-container"><canvas id="statsChart"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Trabajador -->
  <div id="trabajadorModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="trabajadorModalTitle">Nuevo Trabajador</h3>
        <button type="button" class="close" onclick="closeTrabajadorModal()">&times;</button>
      </div>
      <div id="trabajadorAlert"></div>
      <form id="trabajadorForm">
        <input type="hidden" id="trabajadorId" name="id" />
        <div class="form-row">
          <div class="form-group">
            <label for="trabajadorNombre">Nombre *</label>
            <input type="text" id="trabajadorNombre" name="nombre" required />
          </div>
          <div class="form-group">
            <label for="trabajadorApellidos">Apellidos *</label>
            <input type="text" id="trabajadorApellidos" name="apellidos" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="trabajadorCedula">C√©dula *</label>
            <input type="text" id="trabajadorCedula" name="cedula" required />
          </div>
          <div class="form-group">
            <label for="trabajadorDepartamento">Departamento</label>
            <input type="text" id="trabajadorDepartamento" name="departamento" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="trabajadorFechaIngreso">Fecha de Ingreso</label>
            <input type="date" id="trabajadorFechaIngreso" name="fecha_ingreso" />
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="trabajadorActivo" name="activo" checked /> Trabajador activo</label>
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-success" style="flex:1;">Guardar</button>
          <button type="button" class="btn" onclick="closeTrabajadorModal()" style="flex:1;">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Festivo -->
  <div id="festivoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="festivoModalTitle">Nuevo Festivo</h3>
        <button type="button" class="close" onclick="closeFestivoModal()">&times;</button>
      </div>
      <div id="festivoAlert"></div>
      <form id="festivoForm">
        <input type="hidden" id="festivoId" name="id" />
        <div class="form-group">
          <label for="festivoTrabajador">Trabajador *</label>
          <select id="festivoTrabajador" name="trabajador_id" required>
            <option value="">Selecciona un trabajador...</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="festivoFecha">Fecha del Festivo *</label>
            <input type="date" id="festivoFecha" name="fecha_festivo" required />
          </div>
          <div class="form-group">
            <label for="festivoNombre">Nombre del Festivo</label>
            <input type="text" id="festivoNombre" name="nombre_festivo" placeholder="ej. Navidad" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="festivoHoras">Horas Trabajadas *</label>
            <input type="number" id="festivoHoras" name="horas_trabajadas" min="1" max="24" required />
          </div>
          <div class="form-group">
            <label for="festivoDevolucion">Fecha de Devoluci√≥n</label>
            <input type="date" id="festivoDevolucion" name="fecha_devolucion" />
          </div>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="festivoDevuelto" name="devuelto" /> Marcado como devuelto</label>
        </div>
        <div class="form-group">
          <label for="festivoNotas">Notas</label>
          <textarea id="festivoNotas" name="notas" rows="3" placeholder="Observaciones adicionales..."></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-success" style="flex:1;">Guardar</button>
          <button type="button" class="btn" onclick="closeFestivoModal()" style="flex:1;">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Configuraci√≥n -->
  <div id="configModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚öôÔ∏è Configuraci√≥n</h3>
        <button type="button" class="close" onclick="closeConfig()">&times;</button>
      </div>
      <div class="form-group">
        <label>API URL</label>
        <input id="cfgApiUrl" type="url" placeholder="https://script.google.com/macros/s/.../exec" />
      </div>
      <div class="form-row">
        <div class="form-group"><label><input type="checkbox" id="cfgMock" /> Usar MOCK</label></div>
        <div class="form-group"><label><input type="checkbox" id="cfgDebug" /> Debug</label></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-success" onclick="saveConfig()">Guardar</button>
        <button class="btn" onclick="closeConfig()">Cerrar</button>
      </div>
      <div class="subtle">Los cambios se guardan en <span class="kbd">localStorage</span>. Recarga la p√°gina para aplicar completamente.</div>
    </div>
  </div>

  <!-- Modal Pruebas -->
  <div id="testsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üß™ Panel de pruebas</h3>
        <button type="button" class="close" onclick="closeTests()">&times;</button>
      </div>
      <div id="testsOutput"><pre class="debug" id="testsLog">Pulsa "Ejecutar" para correr los tests...</pre></div>
      <div class="form-actions">
        <button class="btn btn-success" onclick="runTests()">Ejecutar</button>
        <button class="btn" onclick="closeTests()">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
  'use strict';
  // ======== CONFIG ========
  const QS = new URLSearchParams(location.search);
  const LS = window.localStorage;
  const DEFAULT_API = 'https://script.google.com/macros/s/AKfycbxrvpO3fDydsFYZeN7FT4Vyln7l5nZ4zx6xeDQ68gsUjL8TKAhy_qIVTYdPOAtnJDBxTw/exec';
  const CONFIG = {
    apiUrl: QS.get('api') || LS.getItem('festivos_api_url') || DEFAULT_API,
    mock: QS.get('mock') === '1' || LS.getItem('festivos_mock') === '1',
    debug: QS.get('debug') === '1' || LS.getItem('festivos_debug') === '1',
    timeoutMs: 12000,
  };

  // ======== STATE ========
  let currentSupervisor = null;
  let currentToken = null;
  let trabajadores = [];
  let festivos = [];
  let stats = {};
  let currentChart = null;
  let lastDebug = [];

  // ======== INIT ========
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('trabajadorForm').addEventListener('submit', handleTrabajadorSubmit);
    document.getElementById('festivoForm').addEventListener('submit', handleFestivoSubmit);

    // UI badges
    const apiBadge = document.getElementById('apiBadge');
    apiBadge.textContent = 'API: ' + (CONFIG.apiUrl || '(no configurada)');
    if (CONFIG.debug) document.getElementById('loginTech').classList.remove('hidden');
    document.getElementById('envInfo').textContent = `${CONFIG.mock ? 'MOCK' : 'LIVE'} ‚Ä¢ ${new URL(CONFIG.apiUrl, location.href).host}`;
    if (!CONFIG.debug) document.getElementById('btnTests').style.display = 'none';

    checkSavedSession();
  });

  // ======== HELPERS ========
  function debugLog(step, payload){
    if (!CONFIG.debug) return;
    const entry = { t:new Date().toISOString(), step, payload };
    lastDebug.push(entry);
    const pre = document.getElementById('loginDebug');
    if (pre) pre.textContent = JSON.stringify(lastDebug.slice(-50), null, 2);
  }

  function fetchWithTimeout(url, options={}){
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort('timeout'), CONFIG.timeoutMs);
    return fetch(url, { ...options, signal: controller.signal, mode:'cors', redirect:'follow', cache:'no-store' })
      .finally(() => clearTimeout(id));
  }

  async function apiCall(action, data={}){
    if (CONFIG.mock) return mockApi(action, data);
    const baseUrl = CONFIG.apiUrl;
    const payload = { action, ...data };
    if (currentToken) payload.token = currentToken;

    const asJson = {
      url: baseUrl,
      options: { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }
    };
    const asForm = {
      url: baseUrl,
      options: { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body: new URLSearchParams({ payload: JSON.stringify(payload) }).toString() }
    };
    const avoidGet = Object.keys(payload).some(k => k.toLowerCase().includes('password'));
    const asGet = avoidGet ? null : {
      url: baseUrl + (baseUrl.includes('?') ? '&' : '?') + new URLSearchParams(payload).toString(),
      options: { method:'GET' }
    };

    const attempts = [asJson, asForm].concat(asGet ? [asGet] : []);
    const errors = [];

    for (const attempt of attempts){
      debugLog('api:request', { url: attempt.url, method: attempt.options.method, hint: attempt===asJson?'json':attempt===asForm?'form':'get' });
      let resp, text;
      try {
        resp = await fetchWithTimeout(attempt.url, attempt.options);
      } catch (e) {
        errors.push(`NETWORK_ERROR(${attempt.options.method}): ${e && e.message}`);
        debugLog('api:network_error', { method: attempt.options.method, message: e && e.message });
        continue;
      }
      const ct = (resp.headers.get('content-type') || '').toLowerCase();
      if (!resp.ok){
        text = await resp.text().catch(()=> '');
        const msg = `HTTP ${resp.status} ${resp.statusText} ‚Ä¢ body: ${text.slice(0,200)}`;
        errors.push(msg);
        debugLog('api:http_error', { method: attempt.options.method, status: resp.status, body: text.slice(0,400) });
        continue;
      }
      if (ct.includes('application/json')){
        const json = await resp.json();
        debugLog('api:response_json', json);
        return json;
      } else {
        text = await resp.text();
        try {
          const json = JSON.parse(text);
          debugLog('api:response_text_as_json', json);
          return json;
        } catch {
          errors.push(`INVALID_JSON(${attempt.options.method}) ‚Ä¢ body: ${text.slice(0,200)}`);
          debugLog('api:invalid_json', { method: attempt.options.method, preview: text.slice(0,300) });
          continue;
        }
      }
    }

    throw new Error(errors.join(' | '));
  }

  // ======== AUTH ========
  async function handleLogin(e){
    e.preventDefault();
    const usuario = document.getElementById('usuario').value.trim();
    const password = document.getElementById('password').value.trim();
    if (!usuario || !password) return showAlert('loginAlert','Por favor completa todos los campos','error');
    showAlert('loginAlert','', '');
    try {
      const response = await apiCall('login', { usuario, password });
      if (response && response.success){
        currentSupervisor = response.data && response.data.supervisor || { usuario };
        currentToken = response.data && response.data.token || '';
        sessionStorage.setItem('festivos_supervisor', JSON.stringify(currentSupervisor));
        sessionStorage.setItem('festivos_token', currentToken);
        showDashboard();
        await loadInitialData();
      } else {
        const msg = response && response.error && response.error.message || 'Error de autenticaci√≥n';
        showAlert('loginAlert', msg, 'error');
      }
    } catch (err){
      const details = (err && (err.message || err.toString())) || 'Error desconocido';
      showAlert('loginAlert', `No se pudo iniciar sesi√≥n.<br><small>${details}</small>`, 'error');
      if (CONFIG.debug) document.getElementById('loginTech').classList.remove('hidden');
      debugLog('login:error', { details });
    }
  }

  function checkSavedSession(){
    const savedSupervisor = sessionStorage.getItem('festivos_supervisor');
    const savedToken = sessionStorage.getItem('festivos_token');
    if (savedSupervisor && savedToken){
      currentSupervisor = JSON.parse(savedSupervisor);
      currentToken = savedToken;
      showDashboard();
      loadInitialData();
    }
  }

  function logout(){
    sessionStorage.clear(); currentSupervisor = null; currentToken = null;
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('loginForm').reset();
    showAlert('loginAlert','', '');
  }

  function showDashboard(){
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    const nombre = currentSupervisor.nombre || currentSupervisor.nombre_completo || currentSupervisor.usuario || 'Supervisor';
    document.getElementById('supervisorName').textContent = nombre;
  }

  // ======== LOADERS ========
  async function loadInitialData(){
    await Promise.all([loadTrabajadores(), loadFestivos()]);
    await loadStats();
  }
  async function loadTrabajadores(){
    showLoading('trabajadoresLoading', true);
    try {
      const response = await apiCall('trabajadores_list');
      if (response.success){
        trabajadores = Array.isArray(response.data.trabajadores) ? response.data.trabajadores : [];
        renderTrabajadores(); updateTrabajadorSelect();
      } else { console.error('Error loading trabajadores:', response.error); }
    } catch (err){ console.error('Error loading trabajadores:', err); }
    finally { showLoading('trabajadoresLoading', false); }
  }
  async function loadFestivos(){
    showLoading('festivosLoading', true);
    try {
      const response = await apiCall('festivos_list');
      if (response.success){
        festivos = Array.isArray(response.data.festivos) ? response.data.festivos : [];
        festivos = festivos.map(f => ({ ...f, horas_trabajadas: Number(f.horas_trabajadas || 0) }));
        renderFestivos();
      } else { console.error('Error loading festivos:', response.error); }
    } catch (err){ console.error('Error loading festivos:', err); }
    finally { showLoading('festivosLoading', false); }
  }
  async function loadStats(){
    try {
      const response = await apiCall('stats');
      if (response.success){
        stats = response.data.stats || {};
        renderStats(); renderChart();
      } else { console.error('Error loading stats:', response.error); }
    } catch (err){ console.error('Error loading stats:', err); }
  }

  // ======== RENDER ========
  function renderTrabajadores(){
    const tbody = document.getElementById('trabajadoresTable');
    if (!trabajadores.length){
      tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><div style="font-size:2rem;margin-bottom:6px;">üë•</div><div>No hay trabajadores registrados</div></td></tr>`;
      return;
    }
    tbody.innerHTML = trabajadores.map(tr => {
      const fecha = tr.fecha_ingreso || '-';
      const activo = !!tr.activo;
      return `
      <tr>
        <td><strong>${tr.nombre_completo || [tr.nombre, tr.apellidos].filter(Boolean).join(' ')}</strong></td>
        <td>${tr.cedula || '-'}</td>
        <td>${tr.departamento || '-'}</td>
        <td>${fecha}</td>
        <td><span class="status-badge ${activo ? 'status-active' : 'status-inactive'}">${activo ? '‚úÖ Activo' : '‚ùå Inactivo'}</span></td>
        <td>
          <button class="btn btn-small" onclick="editTrabajador('${String(tr.id)}')">‚úèÔ∏è Editar</button>
          <button class="btn btn-danger btn-small" style="margin-left:6px;" onclick="deleteTrabajador('${String(tr.id)}','${(tr.nombre_completo || '').replace(/"/g,'&quot;')}')">üóëÔ∏è</button>
        </td>
      </tr>`;
    }).join('');
  }
  function renderFestivos(){
    const tbody = document.getElementById('festivosTable');
    if (!festivos.length){
      tbody.innerHTML = `<tr><td colspan="7" class="empty-state"><div style="font-size:2rem;margin-bottom:6px;">üìÖ</div><div>No hay festivos registrados</div></td></tr>`;
      return;
    }
    tbody.innerHTML = festivos.map(f => `
      <tr>
        <td><strong>${f.trabajador_nombre || '-'}</strong></td>
        <td>${f.fecha_festivo || '-'}</td>
        <td>${f.nombre_festivo || '-'}</td>
        <td><strong>${Number(f.horas_trabajadas || 0)}h</strong></td>
        <td>${f.fecha_devolucion || '-'}</td>
        <td><span class="status-badge ${f.devuelto ? 'status-returned' : 'status-pending'}">${f.devuelto ? '‚úÖ Devuelto' : '‚è≥ Pendiente'}</span></td>
        <td>
          <button class="btn btn-small" onclick="editFestivo('${String(f.id)}')">‚úèÔ∏è Editar</button>
          <button class="btn btn-danger btn-small" style="margin-left:6px;" onclick="deleteFestivo('${String(f.id)}')">üóëÔ∏è</button>
        </td>
      </tr>`).join('');
  }
  function renderStats(){
    const n = x => Number(x || 0);
    document.getElementById('totalRegistros').textContent = n(stats.total_registros);
    document.getElementById('totalHoras').textContent = n(stats.total_horas);
    document.getElementById('horasPendientes').textContent = n(stats.horas_pendientes);
    document.getElementById('horasDevueltas').textContent = n(stats.horas_devueltas);
  }
  function renderChart(){
    const ctx = document.getElementById('statsChart').getContext('2d');
    if (currentChart) currentChart.destroy();
    if (!festivos.length){ currentChart = new Chart(ctx, { type:'bar', data:{ labels:[], datasets:[] }, options:{ responsive:true, maintainAspectRatio:false } }); return; }
    const monthly = {};
    for (const f of festivos){
      const date = (f.fecha_festivo || '').toString();
      if (!date) continue; const month = date.substring(0,7);
      if (!monthly[month]) monthly[month] = { total:0, devuelto:0 };
      const horas = Number(f.horas_trabajadas || 0);
      monthly[month].total += horas; if (f.devuelto) monthly[month].devuelto += horas;
    }
    const months = Object.keys(monthly).sort().slice(-6);
    const totalHours = months.map(m => monthly[m]?.total || 0);
    const returnedHours = months.map(m => monthly[m]?.devuelto || 0);
    const pendingHours = months.map((m,i) => Math.max(0, Number(totalHours[i]) - Number(returnedHours[i])));
    currentChart = new Chart(ctx, { type:'bar', data:{ labels:months, datasets:[
      { label:'Horas Devueltas', data: returnedHours, backgroundColor:'rgba(46, 204, 113, 0.8)', borderColor:'rgba(46, 204, 113, 1)', borderWidth:2 },
      { label:'Horas Pendientes', data: pendingHours, backgroundColor:'rgba(241, 196, 15, 0.8)', borderColor:'rgba(241, 196, 15, 1)', borderWidth:2 }
    ]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ title:{ display:true, text:'Evoluci√≥n de Horas por Mes', font:{ size:16 } }, legend:{ position:'top' } }, scales:{ x:{ title:{ display:true, text:'Mes' } }, y:{ beginAtZero:true, title:{ display:true, text:'Horas' } } } } });
  }
  function updateTrabajadorSelect(){
    const select = document.getElementById('festivoTrabajador');
    select.innerHTML = '<option value="">Selecciona un trabajador...</option>';
    trabajadores.filter(t => !!t.activo).sort((a,b)=>{
      const na=(a.nombre_completo||'').toLowerCase();
      const nb=(b.nombre_completo||'').toLowerCase(); return na.localeCompare(nb);
    }).forEach(t => { const opt = document.createElement('option'); opt.value = String(t.id); opt.textContent = t.nombre_completo || [t.nombre, t.apellidos].filter(Boolean).join(' '); select.appendChild(opt); });
  }

  // ======== TABS ========
  function switchTab(tabName, btn){
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    const panel = document.getElementById(`tab-${tabName}`); if (panel) panel.classList.add('active');
    if (tabName === 'stats') renderChart();
  }

  // ======== MODALS (Trabajador) ========
  function openTrabajadorModal(trabajador=null){
    const modal = document.getElementById('trabajadorModal'); const form = document.getElementById('trabajadorForm'); const title = document.getElementById('trabajadorModalTitle');
    form.reset(); showAlert('trabajadorAlert','', '');
    if (trabajador){
      title.textContent = 'Editar Trabajador';
      const nombre = trabajador.nombre || (trabajador.nombre_completo ? String(trabajador.nombre_completo).split(' ')[0] : '');
      const apellidos = trabajador.apellidos || (trabajador.nombre_completo ? String(trabajador.nombre_completo).split(' ').slice(1).join(' ') : '');
      document.getElementById('trabajadorId').value = String(trabajador.id || '');
      document.getElementById('trabajadorNombre').value = nombre;
      document.getElementById('trabajadorApellidos').value = apellidos;
      document.getElementById('trabajadorCedula').value = trabajador.cedula || '';
      document.getElementById('trabajadorDepartamento').value = trabajador.departamento || '';
      document.getElementById('trabajadorFechaIngreso').value = trabajador.fecha_ingreso || '';
      document.getElementById('trabajadorActivo').checked = !!trabajador.activo;
    } else {
      title.textContent = 'Nuevo Trabajador'; document.getElementById('trabajadorActivo').checked = true;
    }
    modal.style.display = 'block';
  }
  function closeTrabajadorModal(){ document.getElementById('trabajadorModal').style.display = 'none'; }
  function editTrabajador(id){ const trabajador = trabajadores.find(t => String(t.id) === String(id)); if (trabajador) openTrabajadorModal(trabajador); }
  async function deleteTrabajador(id, nombre){
    if (!confirm(`¬øEst√°s seguro de eliminar al trabajador "${nombre}"?`)) return;
    try {
      const response = await apiCall('trabajador_delete', { id });
      if (response.success){ await loadTrabajadores(); await loadStats(); }
      else alert('Error al eliminar trabajador: ' + (response.error && response.error.message));
    } catch (err){ console.error('Error deleting trabajador:', err); alert('Error de conexi√≥n al eliminar trabajador'); }
  }
  async function handleTrabajadorSubmit(e){
    e.preventDefault(); const fd = new FormData(e.target);
    const data = { nombre: (fd.get('nombre')||'').toString().trim(), apellidos:(fd.get('apellidos')||'').toString().trim(), cedula:(fd.get('cedula')||'').toString().trim(), departamento:(fd.get('departamento')||'').toString().trim(), fecha_ingreso: fd.get('fecha_ingreso')||'', activo: fd.has('activo') };
    if (!data.nombre || !data.apellidos || !data.cedula) return showAlert('trabajadorAlert','Por favor completa todos los campos obligatorios','error');
    try {
      const id = fd.get('id'); const action = id ? 'trabajador_update' : 'trabajador_create';
      const payload = id ? { id, trabajador: data } : { trabajador: data };
      const response = await apiCall(action, payload);
      if (response.success){ showAlert('trabajadorAlert','‚úÖ Trabajador guardado exitosamente','success'); setTimeout(()=>{ closeTrabajadorModal(); loadTrabajadores(); loadStats(); }, 700); }
      else { showAlert('trabajadorAlert', (response.error && response.error.message) || 'Error al guardar trabajador','error'); }
    } catch (err){ console.error('Error saving trabajador:', err); showAlert('trabajadorAlert','Error de conexi√≥n al guardar','error'); }
  }

  // ======== MODALS (Festivo) ========
  function openFestivoModal(festivo=null){
    const modal = document.getElementById('festivoModal'); const form = document.getElementById('festivoForm'); const title = document.getElementById('festivoModalTitle');
    form.reset(); showAlert('festivoAlert','', '');
    if (festivo){
      title.textContent = 'Editar Festivo';
      document.getElementById('festivoId').value = String(festivo.id || '');
      document.getElementById('festivoTrabajador').value = String(festivo.trabajador_id || '');
      document.getElementById('festivoFecha').value = festivo.fecha_festivo || '';
      document.getElementById('festivoNombre').value = festivo.nombre_festivo || '';
      document.getElementById('festivoHoras').value = Number(festivo.horas_trabajadas || 0);
      document.getElementById('festivoDevolucion').value = festivo.fecha_devolucion || '';
      document.getElementById('festivoDevuelto').checked = !!festivo.devuelto;
      document.getElementById('festivoNotas').value = festivo.notas || '';
    } else { title.textContent = 'Nuevo Festivo'; }
    modal.style.display = 'block';
  }
  function closeFestivoModal(){ document.getElementById('festivoModal').style.display = 'none'; }
  function editFestivo(id){ const festivo = festivos.find(f => String(f.id) === String(id)); if (festivo) openFestivoModal(festivo); }
  async function deleteFestivo(id){
    if (!confirm('¬øEst√°s seguro de eliminar este registro de festivo?')) return;
    try { const response = await apiCall('festivo_delete', { id }); if (response.success){ await loadFestivos(); await loadStats(); } else alert('Error al eliminar festivo: ' + (response.error && response.error.message)); }
    catch (err){ console.error('Error deleting festivo:', err); alert('Error de conexi√≥n al eliminar festivo'); }
  }
  async function handleFestivoSubmit(e){
    e.preventDefault(); const fd = new FormData(e.target);
    const data = { trabajador_id: fd.get('trabajador_id'), fecha_festivo: fd.get('fecha_festivo'), nombre_festivo:
