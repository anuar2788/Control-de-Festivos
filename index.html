<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Festivos</title>
  <style>
    .badge { padding:3px 8px; border-radius:6px; font-size:12px; }
    .ok { background:#dcfce7; color:#166534; }
    .warn { background:#fee2e2; color:#991b1b; }
  </style>
</head>
<body>
  <!-- Aquí iría tu tabla y formularios -->

  <script>
    const $ = sel => document.querySelector(sel);

    function filtrosFromUI(){
      return {
        local: $('#f-local').value || '',
        estado: $('#f-estado').value || '',
        empleado: $('#f-empleado').value.trim() || '',
        desde: $('#f-desde').value || '',
        hasta: $('#f-hasta').value || ''
      };
    }

    function aplicarFiltros(){
      refrescar();
    }

    function refrescar(){
      const sess = getSession();
      const filtros = filtrosFromUI();
      google.script.run
        .withSuccessHandler(pintarTabla)
        .withFailureHandler(err => alert(err.message || err))
        .api_listFestivos(sess, filtros);
    }

    function pintarTabla(rows){
      const tb = $('#tbody');
      if (!rows || rows.length === 0) {
        tb.innerHTML = '<tr><td colspan="8">Sin registros</td></tr>';
        return;
      }
      tb.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.Fecha||''}</td>
          <td>${r.Empleado||''}</td>
          <td>${r.Local||''}</td>
          <td>${r.Estado==='Devuelto'
              ?'<span class="badge ok">Devuelto</span>'
              :'<span class="badge warn">Pendiente</span>'}</td>
          <td>${r.FechaDevolucion||''}</td>
          <td>${r.Observaciones||''}</td>
          <td>${r.ID||''}</td>
          <td>
            ${r.Estado==='Pendiente'
              ?`<button onclick="marcarDevuelto(${r.ID})">Marcar devuelto</button>`
              :''}
          </td>
        </tr>`).join('');
    }

    function crear(){
      const sess = getSession();
      const payload = {
        Fecha: $('#a-fecha').value,
        Empleado: $('#a-empleado').value.trim(),
        Local: $('#a-local').value,
        Estado: $('#a-estado').value,
        FechaDevolucion: $('#a-fechaDev').value,
        Observaciones: $('#a-obs').value.trim()
      };
      if (!payload.Fecha || !payload.Empleado || !payload.Local) {
        alert('Fecha, Empleado y Local son obligatorios');
        return;
      }
      google.script.run
        .withSuccessHandler(()=>{ limpiarAlta(); refrescar(); })
        .withFailureHandler(err => alert(err.message || err))
        .api_addFestivo(sess, payload);
    }

    function limpiarAlta(){
      $('#a-fecha').value = '';
      $('#a-empleado').value = '';
      $('#a-estado').value = 'Pendiente';
      $('#a-fechaDev').value = '';
      $('#a-obs').value = '';
    }

    function marcarDevuelto(id){
      const sess = getSession();
      const fecha = prompt(
        'Fecha de devolución (yyyy-mm-dd):',
        new Date().toISOString().slice(0,10)
      );
      if (!fecha) return;
      google.script.run
        .withSuccessHandler(()=>refrescar())
        .withFailureHandler(err => alert(err.message || err))
        .api_marcarDevuelto(sess, id, fecha);
    }
  </script>
</body>
</html>
