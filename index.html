<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — Control de Festivos</title>
  <style>
    :root {
      --bg: #0f172a;      /* slate-900 */
      --card: #111827;    /* gray-900 */
      --muted: #94a3b8;   /* slate-400 */
      --text: #e5e7eb;    /* gray-200 */
      --brand: #7c3aed;   /* violet-600 */
      --ok: #10b981;      /* emerald-500 */
      --warn: #f59e0b;    /* amber-500 */
      --danger: #ef4444;  /* red-500 */
      --border: #1f2937;  /* gray-800 */
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0; font: 14px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, system-ui, sans-serif;
      color: var(--text); background: radial-gradient(1200px 600px at 10% -10%, #1f2937 0%, transparent 60%),
                             radial-gradient(1200px 800px at 110% -20%, #1e293b 0%, transparent 60%),
                             var(--bg);
    }
    .container { max-width: 1200px; margin: 32px auto; padding: 0 16px }

    header { display:flex; align-items:center; gap:12px; margin-bottom:18px }
    .logo { width:36px; height:36px; border-radius:12px; background: linear-gradient(135deg, var(--brand), #22d3ee);
            display:grid; place-items:center; font-weight:800 }
    .title { font-size: 22px; font-weight: 800 }
    .muted { color: var(--muted) }

    .grid { display:grid; gap:12px }
    .grid.kpi { grid-template-columns: repeat(4, minmax(0,1fr)); margin-bottom: 14px }
    .card { background: color-mix(in srgb, var(--card) 92%, black 8%); border: 1px solid var(--border); border-radius: 14px; padding: 14px }
    .card h3 { margin: 0 0 6px 0; font-size: 12px; font-weight: 600; color: var(--muted) }
    .card .big { font-size: 28px; font-weight: 800 }

    .row { display:flex; flex-wrap: wrap; gap: 12px }
    .row > * { flex: 1 1 280px }

    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px }
    input, select, button { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #0b1220; color: var(--text) }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1) opacity(0.7) }

    button { cursor: pointer; border: 1px solid color-mix(in srgb, var(--brand) 40%, var(--border) 60%); background: linear-gradient(180deg, color-mix(in srgb, var(--brand) 30%, transparent), transparent) }
    .btn { display:inline-flex; gap:8px; align-items:center; justify-content:center }
    .btn.primary { background: linear-gradient(180deg, color-mix(in srgb, var(--brand) 65%, transparent), transparent); border-color: var(--brand) }
    .btn.success { border-color: var(--ok) }
    .btn.warn { border-color: var(--warn) }
    .btn.danger { border-color: var(--danger) }

    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 14px; border: 1px solid var(--border) }
    thead { background: #0b1220 }
    th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid var(--border) }
    tbody tr:hover { background: #0e1626 }

    .badge { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; border:1px solid var(--border) }
    .badge.ok { background: color-mix(in srgb, var(--ok) 20%, transparent) }
    .badge.pend { background: color-mix(in srgb, var(--warn) 20%, transparent) }

    .toolbar { display:flex; gap:8px; align-items:end }
    .toolbar .grow { flex: 1 1 auto }
    .right { text-align: right }

    .flex { display:flex; gap:8px; align-items:center }
    .center { display:grid; place-items:center }
    .hidden { display: none !important }

    .overdue { outline: 1px solid var(--danger); box-shadow: inset 0 0 0 9999px color-mix(in srgb, var(--danger) 10%, transparent) }

    .toast { position: fixed; right: 16px; bottom: 16px; padding: 10px 12px; border-radius: 12px; background: #0b1220; border:1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,.35) }
    .loading { position: fixed; inset: 0; background: rgba(2,6,23,.55); backdrop-filter: blur(2px); display:none; place-items:center; z-index: 20 }
    .spinner { width: 38px; height: 38px; border: 3px solid #243145; border-top-color: var(--brand); border-radius: 999px; animation: spin 1s linear infinite }
    @keyframes spin { to { transform: rotate(360deg) } }

    @media (max-width: 900px) {
      .grid.kpi { grid-template-columns: repeat(2,minmax(0,1fr)) }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">F</div>
      <div>
        <div class="title">Control de Festivos</div>
        <div class="muted">Añade festivos trabajados, planifica devoluciones y marca cuándo se devuelven.</div>
      </div>
    </header>

    <!-- KPIs -->
    <div class="grid kpi">
      <div class="card"><h3>Pendientes</h3><div id="kpi-pend" class="big">—</div></div>
      <div class="card"><h3>Devueltos</h3><div id="kpi-dev" class="big">—</div></div>
      <div class="card"><h3>Próx. 7 días</h3><div id="kpi-next" class="big">—</div></div>
      <div class="card"><h3>Total registros</h3><div id="kpi-tot" class="big">—</div></div>
    </div>

    <!-- Formularios -->
    <div class="row">
      <div class="card">
        <h3>Nuevo trabajador</h3>
        <form id="form-worker" class="row" onsubmit="return false;">
          <div>
            <label>Nombre</label>
            <input id="w-nombre" placeholder="Nombre" required />
          </div>
          <div>
            <label>Apellidos</label>
            <input id="w-apellidos" placeholder="Apellidos" required />
          </div>
          <div style="align-self:end">
            <button class="btn primary" id="btn-add-worker">Añadir trabajador</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h3>Nuevo festivo trabajado</h3>
        <form id="form-festivo" class="row" onsubmit="return false;">
          <div>
            <label>Trabajador</label>
            <select id="f-trabajador" required></select>
          </div>
          <div>
            <label>Fecha trabajada</label>
            <input type="date" id="f-fecha" required />
          </div>
          <div>
            <label>Fecha devolución (plan)</label>
            <input type="date" id="f-dev-plan" />
          </div>
          <div>
            <label>¿Ya devuelto?</label>
            <select id="f-devuelto">
              <option value="no" selected>No</option>
              <option value="si">Sí</option>
            </select>
          </div>
          <div id="box-dev-real" class="hidden">
            <label>Fecha devuelto</label>
            <input type="date" id="f-dev-real" />
          </div>
          <div style="align-self:end">
            <button class="btn primary" id="btn-add-festivo">Añadir festivo</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card" style="margin-top:12px">
      <h3>Filtros</h3>
      <div class="toolbar">
        <div class="grow">
          <label>Búsqueda (nombre/apellidos)</label>
          <input id="q" placeholder="Escribe para filtrar…" />
        </div>
        <div>
          <label>Estado</label>
          <select id="f-estado">
            <option value="">Todos</option>
            <option value="pendiente">Pendiente</option>
            <option value="devuelto">Devuelto</option>
          </select>
        </div>
        <div>
          <label>Desde</label>
          <input type="date" id="f-desde" />
        </div>
        <div>
          <label>Hasta</label>
          <input type="date" id="f-hasta" />
        </div>
        <div>
          <button class="btn" id="btn-aplicar">Aplicar</button>
        </div>
        <div>
          <button class="btn" id="btn-reset">Reset</button>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="align-items:center; margin-bottom:8px">
        <div class="muted">Registros: <span id="count">—</span></div>
        <div class="right" style="flex:1">
          <button id="btn-export" class="btn">Exportar CSV</button>
        </div>
      </div>
      <table id="tabla">
        <thead>
          <tr>
            <th>Trabajador</th>
            <th>Fecha trabajada</th>
            <th>Devolución (plan)</th>
            <th>Estado</th>
            <th>Fecha devuelto</th>
            <th class="right">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="loading" id="loading"><div class="spinner"></div></div>
  <div class="toast hidden" id="toast"></div>

  <script>
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    let WORKERS = []; // {id, nombre, apellidos}
    let ROWS = [];    // festivos

    // Utils
    const fmt = (d) => d ? new Date(d).toISOString().slice(0,10) : '';
    const parseDate = (v) => v ? new Date(v + 'T00:00:00') : null;
    const toast = (m) => { const t=$('#toast'); t.textContent=m; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2200); };
    const loading = (on) => $('#loading').style.display = on ? 'grid' : 'none';

    // Render workers in select
    function renderWorkers(){
      const sel = $('#f-trabajador');
      sel.innerHTML = '<option value="" disabled selected>Elige trabajador…</option>' +
        WORKERS.map(w=>`<option value="${w.id}">${w.nombre} ${w.apellidos}</option>`).join('');
    }

    function renderStats(stats){
      $('#kpi-pend').textContent = stats.pendientes ?? '0';
      $('#kpi-dev').textContent = stats.devueltos ?? '0';
      $('#kpi-next').textContent = stats.proximos7d ?? '0';
      $('#kpi-tot').textContent = stats.total ?? '0';
    }

    function renderTable(list){
      const tbody = $('#tbody');
      const today = new Date(); today.setHours(0,0,0,0);
      tbody.innerHTML = list.map(r=>{
        const fpd = r.fechaProgDevolucion ? new Date(r.fechaProgDevolucion) : null;
        if (fpd) fpd.setHours(0,0,0,0);
        const overdue = !r.devuelto && fpd && fpd < today;
        const estado = r.devuelto ? `<span class="badge ok">Devuelto</span>`: `<span class="badge pend">Pendiente</span>`;
        return `<tr${overdue? ' class="overdue"':''}>
          <td>${r.nombre ?? ''}</td>
          <td>${fmt(r.fechaTrabajada)}</td>
          <td>${fmt(r.fechaProgDevolucion)}</td>
          <td>${estado}</td>
          <td>${fmt(r.fechaDevuelto)}</td>
          <td class="right">
            <div class="flex" style="justify-content:flex-end">
              <button class="btn warn" ${r.devuelto? 'disabled':''} onclick="editPlan('${r.id}','${fmt(r.fechaProgDevolucion)}')">Editar plan</button>
              <button class="btn success" ${r.devuelto? 'disabled':''} onclick="markDevuelto('${r.id}')">Marcar devuelto</button>
              <button class="btn danger" onclick="delFestivo('${r.id}')">Borrar</button>
            </div>
          </td>
        </tr>`
      }).join('');
      $('#count').textContent = list.length;
    }

    // Server calls (Apps Script)
    function loadAll(){
      loading(true);
      google.script.run.withSuccessHandler(({workers, festivos, stats})=>{
        WORKERS = workers || [];
        ROWS = (festivos || []).slice().sort((a,b)=> new Date(b.fechaTrabajada||0) - new Date(a.fechaTrabajada||0));
        renderWorkers();
        renderTable(ROWS);
        renderStats(stats || {});
        loading(false);
      }).getInitialData();
    }

    function applyFilters(){
      const estado = $('#f-estado').value;
      const q = $('#q').value.trim().toLowerCase();
      const desde = $('#f-desde').value; const hasta = $('#f-hasta').value;
      const filters = { estado, desde, hasta };
      loading(true);
      google.script.run.withSuccessHandler(list=>{
        let filtered = list;
        if(q){ filtered = filtered.filter(r => (`${r.nombre}`.toLowerCase()).includes(q)); }
        ROWS = filtered;
        renderTable(filtered);
        loading(false);
        toast('Filtros aplicados');
      }).getFestivos(filters);
    }

    function resetFilters(){
      $('#q').value = ''; $('#f-estado').value=''; $('#f-desde').value=''; $('#f-hasta').value='';
      loadAll();
    }

    // Actions
    function addWorker(){
      const nombre = $('#w-nombre').value.trim();
      const apellidos = $('#w-apellidos').value.trim();
      if(!nombre || !apellidos) return toast('Completa nombre y apellidos');
      const key = (nombre+' '+apellidos).toLowerCase();
      const exists = WORKERS.some(w => (w.nombre+' '+w.apellidos).toLowerCase() === key);
      if(exists) return toast('Ese trabajador ya existe');
      loading(true);
      google.script.run.withSuccessHandler(()=>{ $('#w-nombre').value=''; $('#w-apellidos').value=''; toast('Trabajador añadido'); loadAll(); })
        .addWorker({nombre, apellidos});
    }

    function addFestivo(){
      const trabajadorId = $('#f-trabajador').value;
      const fechaTrabajada = $('#f-fecha').value;
      const devuelto = $('#f-devuelto').value === 'si';
      const fechaProgDevolucion = $('#f-dev-plan').value || null;
      const fechaDevuelto = $('#f-dev-real').value || null;
      if(!trabajadorId || !fechaTrabajada) return toast('Elige trabajador y fecha trabajada');
      if(devuelto && !fechaDevuelto) return toast('Indica fecha devuelto');
      loading(true);
      google.script.run.withSuccessHandler(()=>{
        $('#form-festivo').reset(); $('#box-dev-real').classList.add('hidden');
        toast('Festivo guardado'); loadAll();
      }).addFestivo({ trabajadorId, fechaTrabajada, devuelto, fechaProgDevolucion, fechaDevuelto });
    }

    function editPlan(id, current){
      const fecha = prompt('Nueva fecha plan (YYYY-MM-DD)', current||'');
      if(!fecha) return;
      loading(true);
      google.script.run.withSuccessHandler(()=>{ toast('Plan actualizado'); loadAll(); }).setPlanDevolucion(id, fecha);
    }

    function markDevuelto(id){
      const fecha = prompt('Fecha devuelto (YYYY-MM-DD)', fmt(new Date()));
      if(!fecha) return;
      loading(true);
      google.script.run.withSuccessHandler(()=>{ toast('Marcado como devuelto'); loadAll(); }).setDevuelto(id, fecha);
    }

    function delFestivo(id){
      if(!confirm('¿Borrar este registro?')) return;
      loading(true);
      google.script.run.withSuccessHandler(()=>{ toast('Registro borrado'); loadAll(); }).deleteFestivo(id);
    }

    // Events
    document.addEventListener('DOMContentLoaded', () => {
      loadAll();
      $('#btn-add-worker').addEventListener('click', addWorker);
      $('#btn-add-festivo').addEventListener('click', addFestivo);
      $('#btn-aplicar').addEventListener('click', applyFilters);
      $('#btn-reset').addEventListener('click', resetFilters);
      $('#btn-export').addEventListener('click', exportCSV);
      $('#f-devuelto').addEventListener('change', (e)=>{
        if(e.target.value==='si'){ $('#box-dev-real').classList.remove('hidden'); }
        else { $('#box-dev-real').classList.add('hidden'); $('#f-dev-real').value=''; }
      });
    });

    // Export CSV (cliente)
    function exportCSV(){
      if(!ROWS.length) return toast('Nada que exportar');
      const cols = ['Trabajador','FechaTrabajada','FechaDevolucionPlan','Estado','FechaDevuelto'];
      const lines = [cols.join(',')].concat(ROWS.map(r=>[
        '"' + (r.nombre||'') + '"',
        fmt(r.fechaTrabajada),
        fmt(r.fechaProgDevolucion),
        r.devuelto? 'Devuelto':'Pendiente',
        fmt(r.fechaDevuelto)
      ].join(',')));
      const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download='festivos.csv'; a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
